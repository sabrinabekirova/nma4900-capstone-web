// ===== CONFIGURATION =====
const USE_JSON_FILE = true; // Set to true to load from artworks.json instead

// ===== GALLERY DATA =====
let artworks = [];

// ===== STATE MANAGEMENT =====
let currentPage = 'page1';
let floorData = null;
let currentSectionIndex = 0;
let sections = [];
let currentFloor = null;

// Floor color schemes
const floorColors = {
    home: '#db4e35',
    control: '#e27349',
    shift: '#3d8999',
    return: '#306d8b'
};

// ===== INITIALIZATION =====
document.addEventListener('DOMContentLoaded', () => {
    if (USE_JSON_FILE) {
        loadArtworksFromJSON();
    } else {
        initializePage1();
        initializePage2();
        initializeModal();
    }
});

// ===== LOAD FROM JSON =====
async function loadArtworksFromJSON() {
    try {
        const response = await fetch('exhibition_data.json');
        const data = await response.json();
        
        // Process the floor data structure
        if (data.exhibition && data.exhibition.floors) {
            floorData = {};
            artworks = [];
            
            data.exhibition.floors.forEach(floor => {
                const floorKey = floor.floor_name.toLowerCase();
                floorData[floorKey] = {
                    number: floor.floor_number,
                    name: floor.floor_name,
                    description: floor.description
                };
                
                // Convert artists to artworks format
                floor.artists.forEach((artist, index) => {
                    artworks.push({
                        id: artworks.length + 1,
                        title: artist.work_title,
                        artist: artist.artist_name,
                        type: 'video',
                        src: `videos/${artist.work_title.toLowerCase().replace(/[^a-z0-9]+/g, '_')}.mp4`,
                        thumbnail: `assets/placeholder.jpg`,
                        category: floorKey,
                        description: artist.work_description,
                        artistBio: artist.artist_bio
                    });
                });
            });
        }
        
        // Update exhibition info if available
        if (data.exhibition) {
            updateExhibitionInfo(data.exhibition);
        }
        
        // Initialize after loading data
        initializePage1();
        initializePage2();
        initializeModal();
    } catch (error) {
        console.error('Error loading exhibition_data.json:', error);
        alert('Unable to load exhibition data. Please check that exhibition_data.json exists.');
    }
}

function updateExhibitionInfo(exhibitionData) {
    // Update about text
    const aboutSection = document.querySelector('#about-section p');
    if (aboutSection && exhibitionData.about) {
        aboutSection.textContent = exhibitionData.about;
    }
    
    // Update visit information
    if (exhibitionData.location) {
        const visitInfo = document.querySelector('.visit-info');
        if (visitInfo) {
            visitInfo.innerHTML = `
                <p><strong>Location:</strong> ${exhibitionData.location.venue}</p>
                <p><strong>Address:</strong> ${exhibitionData.location.address}</p>
                <p><strong>Hours:</strong> ${exhibitionData.location.hours}</p>
                <p><strong>Opening Reception:</strong> ${exhibitionData.location.opening}</p>
            `;
        }
    }
    
    // Update social links
    if (exhibitionData.social) {
        const socialLinks = document.querySelectorAll('.social-link');
        const socialUrls = [
            exhibitionData.social.instagram,
            exhibitionData.social.twitter,
            exhibitionData.social.facebook,
            exhibitionData.social.email
        ];
        socialLinks.forEach((link, index) => {
            if (socialUrls[index]) {
                link.href = socialUrls[index];
            }
        });
    }
}

// ===== PAGE 1 INITIALIZATION =====
function initializePage1() {
    // Setup key card click listeners
    const keyItems = document.querySelectorAll('.key-item');
    
    keyItems.forEach(item => {
        item.addEventListener('click', () => {
            const category = item.dataset.key;
            // Navigate directly to gallery
            navigateToGallery(category);
        });
        
        // Add hover listeners for description switching
        item.addEventListener('mouseenter', () => {
            const category = item.dataset.key;
            switchDescription(category);
        });
    });
    
    // Reset to exhibition description when mouse leaves the icons area
    const iconsContainer = document.querySelector('.floor-icons-vertical');
    if (iconsContainer) {
        iconsContainer.addEventListener('mouseleave', () => {
            switchDescription('exhibition');
        });
    }
    
    // Initialize sections for keyboard navigation
    sections = Array.from(document.querySelectorAll('#page1 section'));
    currentSectionIndex = 0;
    
    // Setup intersection observer for slide animations
    setupSlideAnimations();
}

// ===== DESCRIPTION SWITCHING =====
function switchDescription(category) {
    // Hide all descriptions
    const allDescriptions = document.querySelectorAll('.description-content');
    allDescriptions.forEach(desc => desc.classList.remove('active'));
    
    // Show the selected description
    let targetId = 'exhibition-text';
    if (category === 'home' || category === 'control' || category === 'shift' || category === 'return') {
        targetId = `${category}-text`;
    }
    
    const targetDesc = document.getElementById(targetId);
    if (targetDesc) {
        targetDesc.classList.add('active');
    }
}


// ===== PAGE NAVIGATION =====
function navigateToGallery(category = null) {
    const page2 = document.getElementById('page2');
    
    // Hide page 1, show page 2
    document.getElementById('page1').classList.remove('active');
    page2.classList.add('active');
    
    // Update current floor
    currentFloor = category;
    
    // Set floor data attribute for theming
    if (category) {
        page2.setAttribute('data-floor', category);
    } else {
        page2.removeAttribute('data-floor');
    }
    
    // Update nav bar colors
    updateNavBarColors(category);
    
    // Populate gallery
    populateGallery(category);
    
    // Scroll to top
    window.scrollTo(0, 0);
    
    currentPage = 'page2';
}

function updateNavBarColors(category) {
    const nav = document.querySelector('.gallery-nav');
    
    if (category && floorColors[category]) {
        nav.style.background = floorColors[category];
    } else {
        nav.style.background = 'var(--teal)';
    }
}

function navigateToHome() {
    // Show page 1, hide page 2
    document.getElementById('page2').classList.remove('active');
    document.getElementById('page1').classList.add('active');
    
    // Scroll to top
    window.scrollTo(0, 0);
    
    currentPage = 'page1';
}

function restartExperience() {
    console.log('üîÑ Restarting experience...');
    
    // Navigate to home
    navigateToHome();
}


// ===== PAGE 2 INITIALIZATION =====
function initializePage2() {
    // Navigation buttons
    document.getElementById('restart-btn').addEventListener('click', restartExperience);
    document.getElementById('home-nav-btn').addEventListener('click', () => navigateToGallery('home'));
    document.getElementById('control-nav-btn').addEventListener('click', () => navigateToGallery('control'));
    document.getElementById('shift-nav-btn').addEventListener('click', () => navigateToGallery('shift'));
    document.getElementById('return-nav-btn').addEventListener('click', () => navigateToGallery('return'));
}

// ===== GALLERY POPULATION =====
function populateGallery(filterCategory = null) {
    const galleryGrid = document.getElementById('gallery-grid');
    galleryGrid.innerHTML = '';
    
    // Filter artworks if category is provided
    let displayArtworks = artworks;
    if (filterCategory) {
        displayArtworks = artworks.filter(art => art.category === filterCategory);
    }
    
    // Create gallery items
    displayArtworks.forEach(artwork => {
        const item = createGalleryItem(artwork);
        galleryGrid.appendChild(item);
    });
}

function createGalleryItem(artwork) {
    const item = document.createElement('div');
    item.className = 'gallery-item';
    item.dataset.id = artwork.id;
    
    // Create thumbnail image element
    const mediaElement = document.createElement('img');
    mediaElement.src = artwork.thumbnail || artwork.src;
    mediaElement.alt = artwork.title;
    mediaElement.loading = 'lazy';
    
    // Create overlay with artist and title
    const overlay = document.createElement('div');
    overlay.className = 'gallery-item-overlay';
    overlay.innerHTML = `
        <div class="overlay-title">${artwork.title}</div>
        <div class="overlay-artist">${artwork.artist}</div>
    `;
    
    item.appendChild(mediaElement);
    item.appendChild(overlay);
    
    // Click handler to open modal
    item.addEventListener('click', () => openModal(artwork));
    
    return item;
}

// ===== MODAL FUNCTIONALITY =====
function initializeModal() {
    const modal = document.getElementById('artwork-modal');
    const closeBtn = document.getElementById('modal-close');
    
    // Close modal on X button
    closeBtn.addEventListener('click', closeModal);
    
    // Close modal on background click
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            closeModal();
        }
    });
    
    // Close modal on ESC key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.classList.contains('active')) {
            closeModal();
        }
    });
}

function openModal(artwork) {
    const modal = document.getElementById('artwork-modal');
    const modalBody = document.getElementById('modal-body');
    const modalContent = modal.querySelector('.modal-content');
    
    // Set modal color based on current floor
    const floorModalColors = {
        home: 'rgba(226, 115, 73, 0.5)',
        control: 'rgba(219, 78, 53, 0.5)',
        shift: 'rgba(48, 109, 139, 0.5)',
        return: 'rgba(21, 37, 76, 0.5)'
    };
    
    console.log('Current floor:', currentFloor);
    if (currentFloor && floorModalColors[currentFloor]) {
        const color = floorModalColors[currentFloor];
        console.log('Setting modal color to:', color);
        modalContent.style.setProperty('background-color', color, 'important');
    }
    
    // Create modal content
    let mediaHTML;
    if (artwork.type === 'video') {
        mediaHTML = `<video class="modal-media" controls autoplay loop>
            <source src="${artwork.src}" type="video/mp4">
            Your browser does not support the video tag.
        </video>`;
    } else {
        mediaHTML = `<img class="modal-media" src="${artwork.src}" alt="${artwork.title}">`;
    }
    
    modalBody.innerHTML = `
        ${mediaHTML}
        <h2 class="modal-title">${artwork.title}</h2>
        <p class="modal-artist">by ${artwork.artist}</p>
        
        <div class="modal-description">
            <h3>About the Work</h3>
            <p>${artwork.description}</p>
        </div>
        
        <div class="modal-description">
            <h3>About the Artist</h3>
            <p>${artwork.artistBio}</p>
        </div>
    `;
    
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeModal() {
    const modal = document.getElementById('artwork-modal');
    modal.classList.remove('active');
    document.body.style.overflow = '';
    
    // Stop any playing videos
    const video = modal.querySelector('video');
    if (video) {
        video.pause();
    }
}

// ===== UTILITY FUNCTIONS =====
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Smooth scroll behavior for older browsers
if (!('scrollBehavior' in document.documentElement.style)) {
    const scrollToTop = () => {
        const c = document.documentElement.scrollTop || document.body.scrollTop;
        if (c > 0) {
            window.requestAnimationFrame(scrollToTop);
            window.scrollTo(0, c - c / 8);
        }
    };
}

// ===== PERFORMANCE OPTIMIZATIONS =====
// Lazy load images
if ('IntersectionObserver' in window) {
    const imageObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const img = entry.target;
                img.src = img.dataset.src;
                img.classList.add('fade-in');
                observer.unobserve(img);
            }
        });
    });
    
    // Observe gallery images when they're added to the DOM
    const observeImages = () => {
        const images = document.querySelectorAll('img[data-src]');
        images.forEach(img => imageObserver.observe(img));
    };
}

// ===== SLIDE ANIMATIONS =====
function setupSlideAnimations() {
    // Skip the logo section (first section)
    const animatedSections = Array.from(document.querySelectorAll('#page1 section')).slice(1);
    
    const observerOptions = {
        threshold: 0.15,
        rootMargin: '0px 0px -100px 0px'
    };
    
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('slide-in-visible');
            }
        });
    }, observerOptions);
    
    animatedSections.forEach(section => {
        section.classList.add('slide-in');
        observer.observe(section);
    });
}

// ===== KEYBOARD NAVIGATION FOR PAGE 1 =====
function scrollToSection(index) {
    if (index >= 0 && index < sections.length) {
        currentSectionIndex = index;
        sections[index].scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}

// ===== ACCESSIBILITY =====
// Add keyboard navigation for gallery items
document.addEventListener('keydown', (e) => {
    // Check if modal is active
    const modalActive = document.getElementById('artwork-modal').classList.contains('active');
    
    if (modalActive) {
        // Only allow ESC to close modal (handled elsewhere)
        return;
    }
    
    if (currentPage === 'page1') {
        // Any key press scrolls to next section on page 1
        // Ignore modifier keys
        if (e.key === 'Control' || e.key === 'Alt' || e.key === 'Shift' || e.key === 'Meta') {
            return;
        }
        
        // Prevent default for arrow keys and space
        if ([' ', 'ArrowDown', 'ArrowUp', 'PageDown', 'PageUp'].includes(e.key)) {
            e.preventDefault();
        }
        
        // Scroll to next section on any key press (except arrow up)
        if (e.key === 'ArrowUp' || e.key === 'PageUp') {
            scrollToSection(currentSectionIndex - 1);
        } else {
            scrollToSection(currentSectionIndex + 1);
        }
    } else if (currentPage === 'page2') {
        const galleryItems = document.querySelectorAll('.gallery-item');
        const focusedElement = document.activeElement;
        const currentIndex = Array.from(galleryItems).indexOf(focusedElement);
        
        if (e.key === 'ArrowRight' && currentIndex < galleryItems.length - 1) {
            galleryItems[currentIndex + 1].focus();
        } else if (e.key === 'ArrowLeft' && currentIndex > 0) {
            galleryItems[currentIndex - 1].focus();
        } else if (e.key === 'Enter' && focusedElement.classList.contains('gallery-item')) {
            focusedElement.click();
        }
    }
});

// Make gallery items focusable
document.addEventListener('DOMContentLoaded', () => {
    const galleryItems = document.querySelectorAll('.gallery-item');
    galleryItems.forEach(item => {
        item.setAttribute('tabindex', '0');
    });
});

// ===== CONSOLE MESSAGE =====
console.log('%c Press Any Key To Continue ', 'background: #028b9b; color: #fefce5; font-size: 20px; font-family: "JetBrains Mono", monospace; padding: 10px; border-radius: 5px;');
console.log('Fall 2025 NMA Capstone Exhibition');
console.log('Website developed with ‚ù§Ô∏è');